<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Rastreador Local</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f8;
        }
        #app-container {
            max-width: 600px;
            min-height: 100vh;
            margin: 0 auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            position: relative;
        }
        #openModalBtn {
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #openModalBtn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.7);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Encabezado Fijo -->
        <header class="sticky top-0 bg-indigo-600 text-white p-4 shadow-lg z-10">
            <h1 class="text-xl font-bold">Mis Títulos Locales</h1>
            <p class="text-xs opacity-75 mt-1" id="auth-info">Guardando en la memoria de este dispositivo.</p>
        </header>

        <!-- Lista de Títulos -->
        <main class="p-4 pb-20">
            <div id="titleList" class="space-y-3">
                <p id="loadingMessage" class="text-center text-gray-500 mt-10">Cargando datos locales...</p>
            </div>
        </main>

        <!-- Botón de Acción Flotante (FAB) -->
        <button id="openModalBtn" class="fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full flex items-center justify-center text-3xl font-light focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-150 ease-in-out">
            +
        </button>

        <!-- Modal para Agregar Título (Oculto por defecto) -->
        <div id="addModal" class="fixed inset-0 bg-white bg-opacity-95 z-50 hidden p-4 overflow-y-auto">
            <div class="max-w-md mx-auto">
                <h2 class="text-2xl font-bold text-indigo-700 mb-6">Añadir Nuevo Título</h2>
                <form id="addTitleForm" class="space-y-4">
                    
                    <div>
                        <label for="titleInput" class="block text-sm font-medium text-gray-700 mb-1">Título (Serie o Película)</label>
                        <input type="text" id="titleInput" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <span class="block text-sm font-medium text-gray-700 mb-2">Tipo de Contenido</span>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="contentType" value="Serie" checked class="form-radio text-indigo-600" id="radioSerie">
                                <span class="ml-2">Serie</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="contentType" value="Película" class="form-radio text-indigo-600" id="radioMovie">
                                <span class="ml-2">Película</span>
                            </label>
                        </div>
                    </div>

                    <!-- Campos Condicionales para Series -->
                    <div id="seriesFields" class="space-y-4 p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                        <h3 class="text-lg font-semibold text-indigo-700">Progreso Inicial</h3>
                        <div>
                            <label for="totalSeasonsInput" class="block text-sm font-medium text-gray-700 mb-1">Total de Temporadas</label>
                            <input type="number" id="totalSeasonsInput" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="currentSeasonInput" class="block text-sm font-medium text-gray-700 mb-1">Temporada Actual (Viendo)</label>
                            <input type="number" id="currentSeasonInput" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="currentEpisodeInput" class="block text-sm font-medium text-gray-700 mb-1">Episodio Actual (Viendo)</label>
                            <input type="number" id="currentEpisodeInput" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- Botones de la Modal -->
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="closeModalBtn" class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition duration-150">Cancelar</button>
                        <button type="submit" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">Guardar Título</button>
                    </div>

                </form>
            </div>
        </div>
        
        <!-- Mensaje Modal de Alerta/Info -->
        <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                <h3 id="messageModalTitle" class="text-lg font-bold mb-2 text-indigo-700">Mensaje</h3>
                <p id="messageModalText" class="text-gray-600 mb-4"></p>
                <button onclick="document.getElementById('messageModal').classList.add('hidden')" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">Entendido</button>
            </div>
        </div>

    </div>

    <script>
        // Clave de almacenamiento local
        const STORAGE_KEY = 'mediaTrackerData';

        // Helper para generar IDs únicos (necesario sin Firebase)
        const generateUUID = () => {
            if (typeof crypto.randomUUID === 'function') {
                return crypto.randomUUID();
            }
            // Fallback para navegadores antiguos
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        // --- Lógica de Almacenamiento Local ---
        
        // Carga los datos desde localStorage
        const loadData = () => {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error al cargar localStorage:", e);
                return [];
            }
        };

        // Guarda los datos en localStorage
        const saveData = (data) => {
            try {
                // Ordenar por la fecha de creación simulada antes de guardar
                data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                renderList(); // Volver a dibujar la lista después de guardar
            } catch (e) {
                console.error("Error al guardar en localStorage:", e);
                showMessage("Error de Almacenamiento", "No se pudo guardar la lista en la memoria de tu dispositivo.");
            }
        };

        // Referencias del DOM y helpers
        const addModal = document.getElementById('addModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const addTitleForm = document.getElementById('addTitleForm');
        const titleList = document.getElementById('titleList');
        const seriesFields = document.getElementById('seriesFields');
        const radioSerie = document.getElementById('radioSerie');
        const radioMovie = document.getElementById('radioMovie');
        const loadingMessage = document.getElementById('loadingMessage');

        const showMessage = (title, message) => {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalText').textContent = message;
            document.getElementById('messageModal').classList.remove('hidden');
        };

        // Función para renderizar un ítem
        const renderItem = (data) => {
            const id = data.id;
            
            const isFinished = data.isFinished;
            const cardBgClass = isFinished ? 'bg-green-100 border-green-400' : 'bg-white border-gray-200';
            const finishText = data.type === 'Película' ? (isFinished ? 'Vista' : 'Pendiente') : (isFinished ? 'Finalizada' : 'En Progreso');
            const finishColor = isFinished ? 'text-green-700' : 'text-indigo-700';

            let progressContent;
            
            if (data.type === 'Serie') {
                const buttonText = isFinished ? 'Reiniciar' : 'Sig. Ep.';
                const progressDisplay = isFinished 
                    ? '¡Completada!'
                    : `T${data.currentSeason} - E${data.currentEpisode}`;

                progressContent = `
                    <div class="flex items-center justify-between mt-2">
                        <span class="text-lg font-semibold text-gray-800">${progressDisplay}</span>
                        <div class="flex space-x-2">
                            <button data-id="${id}" data-action="toggleFinish" class="text-sm px-3 py-1 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-100 transition duration-150">
                                ${isFinished ? 'Retomar' : 'Finalizar'}
                            </button>
                            <button data-id="${id}" data-action="nextEpisode" class="bg-indigo-500 hover:bg-indigo-600 text-white font-medium text-sm px-4 py-1 rounded-full transition duration-150">
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        Total: ${data.totalSeasons} Temporadas
                    </p>
                `;
            } else { // Película
                progressContent = `
                    <p class="text-md mt-2 ${finishColor} font-semibold">${finishText}</p>
                    <button data-id="${id}" data-action="toggleFinish" class="mt-2 text-sm px-3 py-1 rounded-full border border-gray-300 text-gray-600 hover:bg-gray-100 transition duration-150">
                        Marcar como ${isFinished ? 'No Vista' : 'Vista'}
                    </button>
                `;
            }


            const item = document.createElement('div');
            item.className = `p-4 rounded-xl border-2 ${cardBgClass} shadow-md flex justify-between items-start transition duration-300 hover:shadow-lg`;
            item.innerHTML = `
                <div class="flex-grow">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xs font-semibold uppercase tracking-wider px-2 py-0.5 rounded-full ${data.type === 'Serie' ? 'bg-red-200 text-red-800' : 'bg-blue-200 text-blue-800'}">
                            ${data.type}
                        </span>
                        <span class="text-xs font-medium ${finishColor}">${finishText}</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900">${data.title}</h3>
                    ${progressContent}
                </div>
                <button data-id="${id}" data-action="delete" class="text-red-500 hover:text-red-700 transition duration-150 p-2 ml-4 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            return item;
        };
        
        // Función principal para dibujar la lista
        const renderList = () => {
            const data = loadData();
            loadingMessage.classList.add('hidden');
            titleList.innerHTML = '';

            if (data.length === 0) {
                titleList.innerHTML = '<p class="text-center text-gray-500 mt-10 p-4 bg-gray-50 rounded-lg">¡Aún no has añadido ningún título! Pulsa el botón "+" para empezar.</p>';
                return;
            }

            data.forEach((item) => {
                const itemElement = renderItem(item);
                titleList.appendChild(itemElement);
            });

            attachActionListeners();
        };

        // Función para guardar un nuevo título
        const saveTitle = (formData) => {
            const currentData = loadData();
            
            const data = {
                id: generateUUID(),
                title: formData.title,
                type: formData.contentType,
                isFinished: false,
                createdAt: Date.now(), // Simula el timestamp
            };

            if (formData.contentType === 'Serie') {
                data.totalSeasons = parseInt(formData.totalSeasons, 10) || 1;
                data.currentSeason = parseInt(formData.currentSeason, 10) || 1;
                data.currentEpisode = parseInt(formData.currentEpisode, 10) || 1;

                if (data.currentSeason > data.totalSeasons) {
                    showMessage("Atención", "La temporada actual no puede ser mayor que el total de temporadas.");
                    return;
                }
            }
            
            currentData.push(data);
            saveData(currentData);
            
            showMessage("Éxito", `"${formData.title}" se ha añadido correctamente.`);
            addModal.classList.add('hidden');
            addTitleForm.reset();
            radioSerie.dispatchEvent(new Event('change'));
        };

        // Función para manejar las acciones de la lista
        const handleAction = (id, action) => {
            let currentData = loadData();
            const index = currentData.findIndex(item => item.id === id);

            if (index === -1) {
                showMessage("Error", "Título no encontrado.");
                return;
            }

            let item = currentData[index];

            if (action === 'delete') {
                 if (!window.confirm(`¿Estás seguro de que quieres eliminar "${item.title}"?`)) return;
                 currentData.splice(index, 1);
                 showMessage("Eliminado", "Título eliminado con éxito.");
            }
            else if (action === 'toggleFinish') {
                if (item.type === 'Película') {
                    item.isFinished = !item.isFinished;
                } else { // Serie
                    if (item.isFinished) {
                        item.isFinished = false;
                        item.currentSeason = 1;
                        item.currentEpisode = 1;
                    } else {
                        item.isFinished = true;
                    }
                }
            } 
            else if (action === 'nextEpisode' && item.type === 'Serie') {
                if (item.isFinished) {
                    item.isFinished = false;
                    item.currentSeason = 1;
                    item.currentEpisode = 1;
                    showMessage("Progreso Reiniciado", `Retomando ${item.title} en T1-E1.`);
                } else {
                    item.currentEpisode += 1;
                    
                    if (item.currentEpisode > 15) { // Lógica para avanzar temporada
                        item.currentEpisode = 1;
                        item.currentSeason += 1;

                        if (item.currentSeason > item.totalSeasons) {
                            item.isFinished = true;
                            showMessage("¡Serie Finalizada!", `¡Has terminado ${item.title}!`);
                        } else {
                            showMessage("Nueva Temporada", `¡Empezando T${item.currentSeason} de ${item.title}!`);
                        }
                    }
                }
            }
            
            saveData(currentData);
        };


        // --- Listeners de Eventos ---

        // Mostrar/Ocultar campos de Serie/Película
        const toggleSeriesFields = () => {
            if (radioSerie.checked) {
                seriesFields.classList.remove('hidden');
            } else {
                seriesFields.classList.add('hidden');
            }
        };

        radioSerie.addEventListener('change', toggleSeriesFields);
        radioMovie.addEventListener('change', toggleSeriesFields);
        
        // Listener para abrir el modal
        openModalBtn.addEventListener('click', () => {
            addModal.classList.remove('hidden');
        });

        // Listener para cerrar el modal
        closeModalBtn.addEventListener('click', () => {
            addModal.classList.add('hidden');
            addTitleForm.reset();
            radioSerie.dispatchEvent(new Event('change')); // Resetear a Serie
        });

        // Listener para el envío del formulario
        addTitleForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const contentType = document.querySelector('input[name="contentType"]:checked').value;
            const formData = {
                title: document.getElementById('titleInput').value.trim(),
                contentType: contentType,
            };

            if (contentType === 'Serie') {
                formData.totalSeasons = document.getElementById('totalSeasonsInput').value;
                formData.currentSeason = document.getElementById('currentSeasonInput').value;
                formData.currentEpisode = document.getElementById('currentEpisodeInput').value;
            }
            
            if (formData.title) {
                saveTitle(formData);
            } else {
                showMessage("Falta Título", "Por favor, ingresa el título de la serie o película.");
            }
        });

        // Listener para los botones de acción en la lista (delegación de eventos)
        const attachActionListeners = () => {
            titleList.querySelectorAll('[data-action]').forEach(button => {
                // Eliminar cualquier listener anterior para evitar duplicados
                button.removeEventListener('click', handleListActionClick); 
                button.addEventListener('click', handleListActionClick);
            });
        };

        const handleListActionClick = (e) => {
            const button = e.currentTarget;
            const id = button.getAttribute('data-id');
            const action = button.getAttribute('data-action');
            handleAction(id, action);
        };

        // --- Inicialización ---
        window.onload = () => {
            renderList(); // Cargar la lista al iniciar
            toggleSeriesFields();
        };

    </script>
</body>
</html>

